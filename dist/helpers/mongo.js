"use strict";var _mongodb=require("mongodb");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=_default;function _default(a,b){let c=()=>new _mongodb.MongoClient(a,{useNewUrlParser:!0,useUnifiedTopology:!0});return{async getFeeds(){const a=await c().connect(),d=a.db(b).collection("feeds"),e=await d.find({listeners:{$gt:0}}).toArray();return a.close(),e.map(a=>a.name)},async subUserToFeed(a,d){let e=null;const f=await c().connect(),g=f.db(b).collection("users"),h=f.db(b).collection("feeds");let[i,j]=await Promise.all([h.findOne({name:a}),g.findOne({id:d})]);return j||(j={id:d,subscribed:[]},await g.insertOne(j)),j.subscribed.includes(a)||(j.subscribed.push(a),e=await Promise.all([g.updateOne({id:d},{$set:{subscribed:j.subscribed}}),i?h.updateOne({name:a},{$set:{listeners:i.listeners+1}}):h.insertOne({name:a,listeners:1})])),f.close(),e},async getFeedListeners(a){const d=await c().connect(),e=d.db(b).collection("users"),f=await e.find({subscribed:{$in:[a]}}).toArray();return d.close(),f.map(a=>a.id)},async unsubUserFromFeed(a,d){let e=null;const f=await c().connect(),g=f.db(b).collection("users"),h=f.db(b).collection("feeds");let[i,j]=await Promise.all([h.findOne({name:a}),g.findOne({id:d})]);return j||(j={id:d,subscribed:[]},await g.insertOne(j)),j.subscribed.includes(a)&&(e=await Promise.all([g.updateOne({id:d},{$set:{subscribed:j.subscribed.filter(b=>b!==a)}}),i?h.updateOne({name:a},{$set:{listeners:i.listeners-1}}):h.insertOne({name:a,listeners:0})])),f.close(),e},async getSubsOfUser(a){const d=await c().connect(),e=d.db(b).collection("users"),f=await e.findOne({id:a});return d.close(),f.subscribed&&f.subscribed.length?f.subscribed:[]}}}